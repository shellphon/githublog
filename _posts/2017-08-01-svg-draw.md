---
layout: post
title: svg画图体会
category: Hellocode
keywords: svg, animation
description: 这几天玩svg动画的一点体会
---

我在上一篇[日志](http://shellphon.wang/githublog/2017/07/infinite-scroll-first.html)里用了svg来画图，一改以往画个流程图然后截图上传的方式，一来方便部署，无须上传图床，二来配合css还能展现动图效果。

工作上一直没碰到过用svg，回想起来第一次见好像是在学习`font-face`的时候，其作为一款字体文件存在？不过查了一下svg的兼容性只到ie9的样子。最近第一次尝试用svg，用来实现触屏版web设计稿中出现的环形进度图，用svg相当方便。也是从这里[学来的>>](https://github.com/chokcoco/SVG),利用svg的`stroke-dasharray`属性的变动来实现进度的变化。

而刚提到的用svg画日志的示意图，也是启发于 [google开发者的某篇文章](https://developers.google.com/web/updates/2016/07/infinite-scroller),其用svg来画动图，以至于本想收藏动图的时候看源码发现，原来还有这种操作！

上述的svg主要是配合css3的animation来做动画的，貌似兼容性方面，chrome新版基本都支持，其他就不敢保证了，所以，如果这里浏览器打开看不到动图或者图不动，那基本就是浏览器不兼容了。

<style>
  svg.process{width:80vw;height:80vw;margin:0 auto} @media (min-width: 48em){svg.process{width:400px;height:400px;margin:0 auto}}svg.infscroll{vector-effect:non-scaling-stroke}svg.infscroll *{vector-effect:inherit}#browser .viewport{stroke:red;stroke-width:4;fill:none}#browser .viewport text{stroke:none;fill:red}.whitener{stroke:none;fill:rgba(255,255,255,0.54)}#runway{stroke:url(#linear);stroke-width:2;fill:none}#runway+text{fill:blue;stroke:none}.pages>use{stroke:none;fill:none}.pages>use:nth-child(1){animation:page1 10s infinite}.pages>use:nth-child(2){animation:page2 10s infinite}.pages>use:nth-child(3){animation:page3 10s infinite}.pages>use:nth-child(4){animation:page4 10s infinite}.pages>use:nth-child(5){animation:pagew1 10s infinite}.pages>use:nth-child(6){animation:pagew2 10s infinite}.pages>use:nth-child(7){animation:pagew3 10s infinite}.pages>use:nth-child(8){animation:pagew4 10s infinite}.pages{animation:items 10s infinite}@keyframes items{0%{transform:translateY(0px)}16%,20%{transform:translateY(-80px)}32%,36%{transform:translateY(-480px)}48%,52%{transform:translateY(-800px)}64%,68%{transform:translateY(-880px)}80%,84%{transform:translateY(-802px)}96%,100%{transform:translateY(-480px)}}@keyframes page1{0%{stroke:#000;fill:yellow}16%,20%{stroke:#000;fill:yellow}32%,36%{stroke:#000;fill:yellow}48%,52%{stroke:#000;fill:none}64%,68%{stroke:#000;fill:none}80%,84%{stroke:#000;fill:yellow}96%,100%{stroke:#000;fill:yellow}}@keyframes page2{0%{stroke:none;fill:none}16%,20%{stroke:#000;fill:yellow}32%,36%{stroke:#000;fill:yellow}48%,52%{stroke:#000;fill:yellow}64%,68%{stroke:#000;fill:yellow}80%,84%{stroke:#000;fill:yellow}96%,100%{stroke:#000;fill:yellow}}@keyframes page3{0%{stroke:none;fill:none}16%,20%{stroke:none;fill:none}32%,36%{stroke:#000;fill:yellow}48%,52%{stroke:#000;fill:yellow}64%,68%{stroke:#000;fill:yellow}80%,84%{stroke:#000;fill:yellow}96%,100%{stroke:#000;fill:yellow}}@keyframes page4{0%{stroke:none;fill:none}16%,20%{stroke:none;fill:none}32%,36%{stroke:none;fill:none}48%,52%{stroke:none;fill:none}64%,68%{stroke:#000;fill:yellow}80%,84%{stroke:#000;fill:yellow}96%,100%{stroke:#000;fill:none}}
  .item1{animation:move1 9s infinite}.item2{animation:move2 9s infinite}.item3{animation:move3 9s infinite}.item4{animation:move4 9s infinite}.item5{animation:move5 9s infinite}.item6{animation:move6 9s infinite}.line{animation:line 9s infinite}@keyframes move1{0%{transform:translate(0px,0px)}10%,100%{transform:translate(200px,0px)}}@keyframes move2{0%,10%{transform:translate(0px,0px)}20%,100%{transform:translate(320px,-110px)}}@keyframes move3{0%,20%{transform:translate(0px,0px)}40%,100%{transform:translate(440px,-280px)}}@keyframes move4{0%,40%{transform:translate(0px,0px)}60%,100%{transform:translate(440px,-290px)}}@keyframes move5{0%,60%{transform:translate(0px,0px)}80%,100%{transform:translate(200px,-410px)}}@keyframes move6{0%,80%{transform:translate(0px,0px)}90%,100%{transform:translate(320px,-580px)}}@keyframes line{0%,40%{transform:translateY(0px)}50%,60%{transform:translateY(50px)}65%,80%{transform:translateY(100px)}85%,90%{transform:translateY(150px)}98%,100%{transform:translateY(210px)}}
  .item{stroke:#000;fill:#fff;}.face{stroke:none;animation:pink 8s infinite;}.hand{stroke:#000;transform-origin:0 0;}#heart path{transform-origin:center center;transform:scale(0.4) rotate(90deg);fill:red;}#talk{opacity:0;animation:talk 8s infinite;}#heart{animation:hand 8s infinite;transform-origin:top center;}.head-part{animation:shy 8s infinite;transform-origin:center center;}@keyframes hand{0%,20%{transform:rotate(0deg);}25%,100%{transform:rotate(-90deg);}}@keyframes talk{0%,45%{opacity:0;}50%,100%{opacity:1;}}@keyframes pink{0%,70%{fill:none;}75%,100%{fill:pink;}}@keyframes shy{0%,65%{transform:rotate(0deg);}75%,100%{transform:rotate(-30deg);}}
</style>

秀一下最近画的三个图吧，两个示意图+一个小动画

[戳这里去找源码](http://runjs.cn/detail/urakrqoq)

<svg  class="process" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 800 1200" >
  <rect x="0" y="0" width="800" height="1200" fill="#fff" ></rect>
  <rect x="200" y="10" width="400" height="1000" stroke='red' stroke-width='4' fill="#fff" ></rect>
  
  <rect class="item1" x="10" y="10" width="100" height="100" stroke='#eee' stroke-width='2' fill="#999" ></rect>
  <rect class="item2" x="10" y="120" width="100" height="150" stroke='#eee' stroke-width='2' fill="#999" ></rect>
  <rect class="item3" x="10" y="290" width="100" height="50" stroke='#eee' stroke-width='2' fill="#999" ></rect>
  
  <rect class="item4" x="10" y="360" width="100" height="150" stroke='#eee' stroke-width='2' fill="#999" ></rect>
  <rect class="item5" x="10" y="530" width="100" height="200" stroke='#eee' stroke-width='2' fill="#999" ></rect>
  <rect class="item6" x="10" y="750" width="100" height="130" stroke='#eee' stroke-width='2' fill="#999" ></rect>
  <line class="line" x1='120' y1='10' x2='680' y2='10' stroke='blue' stroke-width="4" stroke-dasharray="20 10"></line>
</svg>

[戳这里去找源码](http://runjs.cn/detail/7zgdevpk)

<svg class="process infscroll" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 -800 800 1800" preserveAspectRatio="xMidYMid meet" style="vector-effect: non-scaling-stroke;background-color:white;"><defs><linearGradient id="linear" x1="0%" y1="0%" x2="0%" y2="1000%"><stop offset="0%" stop-color="rgba(0, 0, 255, 0)"></stop><stop offset="5%" stop-color="rgba(0, 0, 255, 1)"></stop></linearGradient><g id="page"><rect x="50" y="0" width="200" height="400"></rect>     <text class="ptext" x="60" y="50"  font-size="36">page</text></g></defs><g id="runway"><rect x="0" y="-500" width="300" height="2280"></rect></g><text x="100" y="0" transform="rotate(-90)" font-size="60">html</text><g class="pages">    <use xlink:href="#page" x="0" y="0"></use><use xlink:href="#page" x="0" y="401"></use><use xlink:href="#page" x="0" y="802"></use>    <use xlink:href="#page" x="0" y="1203"></use></g><g id="browser"><g class="viewport"><rect x="0" y="0" width="300" height="300"></rect><text x="-300" y="-32" transform="rotate(-90)" font-size="64">Viewport</text></g></g>  <g id="claim">    <text x="400" y="0" font-size="64">背景色代表page有实体内容</text>    <text x="400" fill="red" y="80" font-size="64">page滑到接近底部加载page</text>    <text x="400" y="160" font-size="64">保证可视page的临近有内容</text>  </g></svg>

[戳这里去找源码](http://runjs.cn/detail/qf65tz8w)

<svg class="process" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 800 800">
  <rect class="bkg" x='0' y='0' width="800" height="800" stroke="#333" fill="#fff"></rect>
  <g id="boy">
    <circle class="head item" cx="150" cy="400" r="50"></circle>
    <ellipse class="item face" cx="170" cy="410" rx="20" ry="5" />
    <path class="body item" d="M150,450 l-100,350 l200,0Z"/>
    <g id="heart">
      <line class="hand" x1="150" y1="500" x2="150" y2="650"/>
      <path d="M150,720 l -70.7,-70.7 a 50 50  0 0 1  70.7 -70.74 a 50 50  0 0 1  70.7 70.74 l -70.7 70.7z "  stroke="#fff" stroke-width="1" ></path>
    </g>
    <g id="talk">
      <path class="item" d="M150,300 l-30,-30 l-100,0 l0,-220 l500,0 l0,220 l-340,0 Z"/>
      <text x="200" y="150" text-anchor="middle" font-size="40">我喜欢你</text>
    </g>
  </g>  
  <g id="girl">
    <g class="head-part">
    <circle class="head item" cx="650" cy="400" r="50"></circle>
      <circle class="eye item" cx="620" cy="400" r="5"></circle>
    <ellipse class="item face" cx="630" cy="410" rx="20" ry="5" />
    </g>
    <path class="body item" d="M650,450 l-100,350 l200,0Z"/>
    <line class="hand" x1="650" y1="500" x2="650" y2="650"/>
  </g>  
</svg>


### 关于svg入门

我直接在mdn 发现 [svg入门](https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial)，然后跟着边看边写代码验证的。貌似还有补充的内容没跟上，不过认识基本的文字text和图形也就差不多了。

较为复杂需要认真学习的是`path`(画路径) 以及 其`贝赛尔曲线`，而path本身足够强大，基本可以画出任何图形来，比如小动画里的爱心，就是用path画出来的。

### 多形状的动画联动

以上述小动画为例，简单介绍一下多个形状之间的animation是如何联动的，[关于animation](https://developer.mozilla.org/zh-CN/docs/Web/CSS/animation)，其中主要用到的4个属性：animation-name、
animation-duration、animation-delay、animation-iteration-count，分别指的是 指定的动画、动画持续时间、动画开始延迟时间、动画迭代次数。

一般来说动画基本是设定成循环播放的，所以迭代次数一般设为：`infinite`。

我们先用svg把基本形状都画出来

{%highlight html%}
<svg class="process" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 800 800">
<!-- 背景 -->
  <rect class="bkg" x='0' y='0' width="800" height="800" stroke="#333" fill="#fff"></rect>
<!-- 左侧男孩 -->
  <g id="boy">
    <!-- 头部 -->
    <circle class="head item" cx="150" cy="400" r="50"></circle>
    <!-- 脸颊部分，用于害羞 -->
    <ellipse class="item face" cx="170" cy="410" rx="20" ry="5" />
    <!-- 身体部分 -->
    <path class="body item" d="M150,450 l-100,350 l200,0Z"/>
    <!-- 爱心和手组合 -->
    <g id="heart">
      <line class="hand" x1="150" y1="500" x2="150" y2="650"/>
      <path d="M150,720 l -70.7,-70.7 a 50 50  0 0 1  70.7 -70.74 a 50 50  0 0 1  70.7 70.74 l -70.7 70.7z "  stroke="#fff" stroke-width="1" ></path>
    </g>
    <!-- 对话框 -->
    <g id="talk">
      <path class="item" d="M150,300 l-30,-30 l-100,0 l0,-220 l500,0 l0,220 l-340,0 Z"/>
      <text x="200" y="150" text-anchor="middle" font-size="40">我喜欢你</text>
    </g>
  </g> 
<!-- 右侧女孩 --> 
  <g id="girl">
    <g class="head-part">
    <circle class="head item" cx="650" cy="400" r="50"></circle>
    <!-- 眼睛，用于标识低头的一个视觉参照 -->
      <circle class="eye item" cx="620" cy="400" r="5"></circle>
    <ellipse class="item face" cx="630" cy="410" rx="20" ry="5" />
    </g>
    <path class="body item" d="M650,450 l-100,350 l200,0Z"/>
    <line class="hand" x1="650" y1="500" x2="650" y2="650"/>
  </g>  
</svg>
{%endhighlight%}

基本形状画出来之后，就是一连串动作的一个定义了，首先是手拿红心向上前方抬起（动作1），然后出现对话框表白（动作2），然后就是脸颊变红，同时被表白对象还低下头表害羞状（动作3）。

因为每个动作的对象，并不都是一个形状，无法用单个animation来实现，而多个animation之间有一个顺序的关系在里面，那就是动作2必须要在动作1完成之后才能开始行动，听起来，好像用animation-delay就可以搞定了。

然而，我一开始也是考虑delay，结果效果一出来懵逼了一会，那就是一开始正常，后面动作就不连贯，甚至出现同步了，为什么呢？因为delay指的是动画开始的延迟时间，并不是每次动画开始的延迟时间，当动画是循环播放时，这个delay只作用于动画第一次播放，后面就没有delay什么事了，于是联动效果扑街~

主要做法是，把动作都定成一样的时长，将动作的状态分解到keyframes的百分比去。

比如，抬起手和对话框呈现的动作。可以这么定义

{%highlight css%}
 @keyframes hand{
    0%,20%{
      transform: rotate(0deg);
    }
    25%,100%{
      transform: rotate(-90deg);
    }
  }
  @keyframes talk{
    0%,45%{
      opacity: 0;
    }
    50%,100%{
      opacity: 1;
    }
  }
{%endhighlight%}

手在`20%-25%`处开始执行动作，并在往后一直保持动作后状态，而对话框则是在`45%-50%`开始动作，并随后保持。

那么这个时间阶段怎么确定呢？

目前我是这么来的（不一定靠谱），比如现在有四个顺序动作，那么100分成了4份，于是`0-25-50-75-100`.

再然后每个阶段往前推移一点定义一下动作前的保持，比如25，取20，于是第一个动作的执行时长阶段时在`20%-25%`，后面只是做动作结尾的一个保持。理解了这个之后动画联动就没那么难理解了。

其中svg画图，我觉得确定动画阶段挺麻烦的，但更麻烦的，估计是画图的时候坐标的考虑问题吧。而动作那块基本上无非就是transform的属性设置了。

